<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Asistencia – Orquestando 2026</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:url("fondo-orquestando.jpg") no-repeat center center fixed;
  background-size:cover;
}

.container{
  background:rgba(255,255,255,0.95);
  max-width:1200px;
  margin:30px auto;
  padding:25px;
  border-radius:20px;
}

header{text-align:center;}
header img{max-width:220px;}

h2,h3{color:#5a4bcf;}

select,input[type="date"]{
  padding:8px;
  margin:5px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
}

th{background:#5a4bcf;color:white;}

.A{background:#2ecc71;color:white;font-weight:bold;}
.T{background:#f39c12;color:white;font-weight:bold;}
.J{background:#3498db;color:white;font-weight:bold;}
.F{background:#e74c3c;color:white;font-weight:bold;}

button{
  padding:10px 20px;
  margin:5px;
  background:#5a4bcf;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.small{font-size:12px;}
</style>
</head>

<body>
<div class="container">

<header>
  <img src="logo-orquestando.png">
  <h2>Asistencia – Orquestando 2026</h2>
</header>

<hr>

<label>Educador:</label>
<select id="educador"></select>

<label>Grupo:</label>
<select id="grupo"></select>

<label>Fecha:</label>
<input type="date" id="fecha">

<table>
<thead>
<tr>
  <th>Alumno</th>
  <th>Asistencia</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<br>

<button onclick="guardarAsistencia()">Guardar asistencia</button>
<button onclick="verReporteMensual()">Ver reporte mensual</button>
<button onclick="descargarReporte()">Descargar informe mensual</button>

<div id="reporte"></div>

</div>

<script>
const CSV_URL="https://raw.githubusercontent.com/elvisade/Asistencia-ni-os-vacacional-2026/main/ninos.csv";
let estructura={}, asistencias=[];

/* ===== CARGA CSV ===== */
fetch(CSV_URL).then(r=>r.text()).then(text=>{
  const l=text.trim().split("\n");
  const h=l[0].toLowerCase().split(",");
  const iE=h.findIndex(x=>x.includes("educador"));
  const iG=h.findIndex(x=>x.includes("grupo"));
  const iN=h.findIndex(x=>x.includes("nombre"));
  const iA=h.findIndex(x=>x.includes("apellido"));

  for(let i=1;i<l.length;i++){
    const c=l[i].split(",");
    const e=c[iE].trim(), g=c[iG].trim();
    const al=`${c[iN].trim()} ${c[iA].trim()}`;
    if(!estructura[e])estructura[e]={};
    if(!estructura[e][g])estructura[e][g]=[];
    estructura[e][g].push(al);
  }

  educador.innerHTML=`<option></option>`+
    Object.keys(estructura).map(e=>`<option>${e}</option>`).join("");
});

educador.onchange=()=>{
  grupo.innerHTML=`<option></option>`;
  tabla.innerHTML="";
  if(!estructura[educador.value])return;
  grupo.innerHTML+=Object.keys(estructura[educador.value])
    .map(g=>`<option>${g}</option>`).join("");
};

grupo.onchange=cargarTabla;

/* ===== TABLA MARCADO ===== */
function cargarTabla(){
  tabla.innerHTML="";
  estructura[educador.value][grupo.value].forEach((a,i)=>{
    tabla.innerHTML+=`
    <tr>
      <td>${a}</td>
      <td>
        <select id="a${i}" onchange="this.className=this.value">
          <option value=""></option>
          <option value="A" class="A">A</option>
          <option value="T" class="T">T</option>
          <option value="J" class="J">J</option>
          <option value="F" class="F">F</option>
        </select>
      </td>
    </tr>`;
  });
}

/* ===== GUARDAR ===== */
function guardarAsistencia(){
  if(!fecha.value)return alert("Seleccione fecha");
  estructura[educador.value][grupo.value].forEach((a,i)=>{
    const v=document.getElementById(`a${i}`).value;
    if(v)asistencias.push({
      fecha:fecha.value,educador:educador.value,
      grupo:grupo.value,alumno:a,estado:v
    });
  });
  alert("✔ Asistencia guardada");
}

/* ===== REPORTE DETALLADO ===== */
function verReporteMensual(){
  const mes=prompt("Mes/Año (MM/YYYY)","01/2026");
  if(!mes)return;
  const [m,y]=mes.split("/").map(Number);
  const data={};

  asistencias.forEach(r=>{
    const d=new Date(r.fecha);
    if(d.getMonth()+1===m && d.getFullYear()===y){
      const k=r.alumno+r.grupo;
      if(!data[k]){
        data[k]={alumno:r.alumno,grupo:r.grupo,
          A:[],T:[],J:[],F:[]};
      }
      data[k][r.estado].push(r.fecha);
    }
  });

  let html=`<h3>Reporte mensual ${mes}</h3>
  <table>
  <tr>
    <th>Alumno</th><th>Grupo</th>
    <th class="A">A</th>
    <th class="T">T</th>
    <th class="J">J</th>
    <th class="F">F</th>
    <th>% Asistencia</th>
  </tr>`;

  Object.values(data).forEach(r=>{
    const tot=r.A.length+r.T.length+r.J.length+r.F.length;
    const pct=tot?(((r.A.length+r.J.length)/tot)*100).toFixed(1):0;
    html+=`
    <tr>
      <td>${r.alumno}</td>
      <td>${r.grupo}</td>
      <td class="A small">${r.A.join("<br>")}</td>
      <td class="T small">${r.T.join("<br>")}</td>
      <td class="J small">${r.J.join("<br>")}</td>
      <td class="F small">${r.F.join("<br>")}</td>
      <td><b>${pct}%</b></td>
    </tr>`;
  });

  html+="</table>";
  reporte.innerHTML=html;
}

/* ===== DESCARGAR CSV ===== */
function descargarReporte(){
  let csv="Alumno,Grupo,Asistio,Tardanza,Justificado,Falta,Porcentaje\n";
  document.querySelectorAll("#reporte table tr").forEach((tr,i)=>{
    if(i>0){
      csv+=[...tr.children].map(td=>td.innerText.replace(/\n/g," | ")).join(",")+"\n";
    }
  });
  const b=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="reporte_mensual_orquestando.csv";
  a.click();
}
</script>

</body>
</html>
