<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Asistencia Orquestando 2026</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  margin: 20px;
}

h1 {
  text-align: center;
}

.controls {
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

select {
  font-size: 14px;
}

button {
  margin-top: 15px;
  padding: 10px 20px;
  font-size: 16px;
}
</style>
</head>

<body>

<h1>Asistencia â€“ Orquestando 2026</h1>

<div class="controls">
  <label>Educador:</label>
  <select id="educador"></select>

  <label>Fecha:</label>
  <input type="date" id="fecha">
</div>

<table>
  <thead>
    <tr>
      <th>Alumno</th>
      <th>Grupo</th>
      <th>Asistencia</th>
    </tr>
  </thead>
  <tbody id="tabla"></tbody>
</table>

<button onclick="guardarAsistencia()">Guardar Asistencia</button>

<script type="module">
import { db } from "./firebase.js";
import { collection, addDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const CSV_URL =
"https://raw.githubusercontent.com/elvisade/Asistencia-ni-os-vacacional-2026/main/alumnos.csv";

let alumnos = [];
let educadores = new Set();

// ðŸ”¹ CARGAR CSV
fetch(CSV_URL)
  .then(res => res.text())
  .then(texto => {
    const filas = texto.trim().split("\n");
    filas.shift(); // quitar encabezado

    filas.forEach(fila => {
      const [educador, grupo, nombres, apellidos] = fila.split(",");

      alumnos.push({
        educador,
        grupo,
        nombreCompleto: `${nombres} ${apellidos}`
      });

      educadores.add(educador);
    });

    cargarEducadores();
  });

// ðŸ”¹ LLENAR SELECT EDUCADORES
function cargarEducadores() {
  const sel = document.getElementById("educador");
  sel.innerHTML = `<option value="">Seleccione</option>`;

  educadores.forEach(e => {
    sel.innerHTML += `<option value="${e}">${e}</option>`;
  });

  sel.addEventListener("change", renderTabla);
}

// ðŸ”¹ MOSTRAR TABLA POR EDUCADOR
function renderTabla() {
  const educadorSel = document.getElementById("educador").value;
  const tbody = document.getElementById("tabla");
  tbody.innerHTML = "";

  alumnos
    .filter(a => a.educador === educadorSel)
    .forEach(a => {
      tbody.innerHTML += `
        <tr>
          <td>${a.nombreCompleto}</td>
          <td>${a.grupo}</td>
          <td>
            <select
              data-nombre="${a.nombreCompleto}"
              data-grupo="${a.grupo}"
              data-educador="${a.educador}">
              <option value="">-</option>
              <option value="A">A</option>
              <option value="T">T</option>
              <option value="J">J</option>
              <option value="F">F</option>
            </select>
          </td>
        </tr>
      `;
    });
}

// ðŸ”¹ GUARDAR ASISTENCIA
window.guardarAsistencia = async () => {
  const fecha = document.getElementById("fecha").value;

  if (!fecha) {
    alert("Seleccione fecha");
    return;
  }

  const selects = document.querySelectorAll("select[data-nombre]");

  for (let s of selects) {
    if (s.value !== "") {
      await addDoc(collection(db, "asistencias"), {
        educador: s.dataset.educador,
        grupo: s.dataset.grupo,
        alumno: s.dataset.nombre,
        fecha: fecha,
        estado: s.value
      });
    }
  }

  alert("Asistencia registrada correctamente âœ”");
};
</script>

</body>
</html>
